{
  "hash": "c172e0ad807a18b57b78a9e9b07510bc",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Production Indicator Refinement\"\nformat:\n  html:\n    fig-dpi: 200\n---\n\n::: {.cell}\n\n:::\n\n\n\n\nThis page describes the various iterations of indicator sets for the production dimension. First, we observe the indicators included in the dimension at three points in time. The second section then shows the results of the survey following the indicator refinement meeting. \n\n## Indicator Progression\n\n### Wiltshire\n\nThis graph shows the original framework for the dimension as described in the Wiltshire et al. paper.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Use custom function in SMDO repo\nsource('dev/get_dimension_ggraph.R')\nget_dimension_ggraph(\n  csv_path = 'data/trees/wiltshire_tree.csv',\n  dimension_in = 'Production',\n  y_limits = c(-1.5, 2.1),\n  palette = \"ggthemes::stata_s2color\"\n)\n```\n\n::: {.cell-output-display}\n![](refine_production_files/figure-html/wiltshire_dendro-1.png){fig-align='center' width=2000}\n:::\n:::\n\n\n\n\n### Matrix\n\nHere is the current set of indicators in the matrix, following the Sustainability Metrics workshop in July, 2024\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Use custom function in SMDO repo\nsource('dev/get_dimension_ggraph.R')\nget_dimension_ggraph(\n  csv_path = 'data/trees/matrix_tree.csv',\n  dimension_in = 'Production',\n  y_limits = c(-1.5, 2.1),\n  palette = \"ggthemes::stata_s2color\"\n)\n```\n\n::: {.cell-output-display}\n![](refine_production_files/figure-html/matrix_dendro-1.png){fig-align='center' width=2200}\n:::\n:::\n\n\n\n\n## Survey\n\nThese are the results from the follow-up survey to the production indicator refinement meeting on January 15th. This feedback will be used to refine the framework for the next RFP.\n\n### Indicators\n\n\n\n\n::: {.cell warnings='false'}\n\n```{.r .cell-code}\nraw <- read_csv('data/surveys/prod_survey.csv')\n\ndat <- raw %>% \n  select(\n    ends_with('GROUP'),\n  ) %>% \n  setNames(c(\n    'indi_must',\n    'indi_probably',\n    'indi_probably_not',\n    'indi_must_not',\n    'idx_must',\n    'idx_probably',\n    'idx_probably_not',\n    'idx_must_not'\n  )) %>% \n  .[-c(1:2), ]\n\nto_df <- function(x) {\n  if (all(is.na(x))) {\n    return(NULL)\n  } else {\n   x %>%\n    str_remove(' \\\\(joint indicator with Marketability\\\\)') %>%\n    str_remove('\\\\*.*') %>%\n    str_remove(' \\\\(see notes with questions') %>%\n    str_split(',(?!\\\\s)') %>% # Split on comma not followed by a space\n    unlist() %>% \n    table() %>% \n    as.data.frame() %>% \n    setNames(c('indicator', 'freq')) %>% \n     arrange(desc(freq))\n  }\n}\n\nindi_out <- map(dat[1:4], to_df)\nidx_out <- map(dat[5:8], to_df)\n\n# Add scores by multipliers\nmultipliers <- c(3:0)\nind_tables <- map2(indi_out, multipliers, ~ {\n  .x %>% \n    mutate(\n      freq = as.numeric(freq),\n      multiplier = .y,\n      score = freq * multiplier,\n    ) %>% \n    select(indicator, freq, score)\n})\n\n# Set up DF for color graph \ngraph_table <- imap(ind_tables, ~ {\n  col_name <- str_remove(.y, 'indi_')\n  .x %>% \n    rename(!!sym(col_name) := freq) %>% \n    select(-score)\n})\n\ngraph_table <- graph_table %>% \n  reduce(full_join) %>% \n  mutate(\n    across(where(is.numeric), ~ ifelse(is.na(.x), 0, .x)),\n    sort_key = must * 1e6 + probably * 1e4 + probably_not * 1e2 + must_not,\n    indicator = fct_reorder(indicator, sort_key, .desc = TRUE)\n  ) %>% \n  pivot_longer(\n    cols = must:must_not,\n    names_to = \"category\",\n    values_to = \"count\"\n  ) %>% \n  mutate(\n    category = fct_relevel(\n      category, \n      \"must_not\",\n      \"probably_not\", \n      \"probably\", \n      \"must\"\n    )\n  ) %>%\n  group_by(indicator) %>%\n  mutate(proportion = count / sum(count)) %>%\n  ungroup()\n\n# Note some missing data throws off the graph table. Fix it here\ngraph_table_clean <- graph_table %>% \n  mutate(\n    sort_key = case_when(\n      str_detect(indicator, 'Production Species Diversity') ~ 3e6,\n      str_detect(indicator, 'Not livestock specific') ~ 1010002,\n      .default = sort_key\n    )\n  )\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(graph_table_clean, aes(\n  y = reorder(indicator, sort_key),\n  x = proportion, \n  fill = category\n)) +\n  geom_col(position = \"stack\") +  \n  labs(\n    y = \"Indicator\",\n    x = \"Proportion\",\n    fill = \"Category\"\n  ) +\n  theme_minimal() +\n  theme(\n    text = element_text(size = 20),\n    legend.position = 'top'\n    ) +\n  scale_fill_brewer(\n    palette = \"RdBu\", \n    direction = -1,\n    limits = c(\n      \"must\",\n      \"probably\", \n      \"probably_not\", \n      \"must_not\" \n    ),\n    labels = c(\n      \"Must Include\", \n      \"Probably Include\", \n      \"Probably Not Include\", \n      \"Must Not Include\"\n    )\n  )\n```\n\n::: {.cell-output-display}\n![](refine_production_files/figure-html/indi_graph-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n\n\nWe are coding this so \"Must Include\" is worth 3 points, \"Probably Include\" is worth 2 points, \"Probably Not Include\" is worth 1 point, and \"Must Not Include\" is worth 0 points. Note that the last column is the sum of proportions of \"Must Include\" and \"Probably Include\". You can sort, search, expand, or page through the table below.\n\n\n\n\n::: {.cell warnings='false' class='centered-table'}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"reactable html-widget html-fill-item\" id=\"htmlwidget-3a8a3c59b81b1b1f1579\" style=\"width:auto;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-3a8a3c59b81b1b1f1579\">{\"x\":{\"tag\":{\"name\":\"Reactable\",\"attribs\":{\"data\":{\"Indicator\":[\"NEW: \\\"Best Practice Adoption, Innovation\\\"\",\"NEW: \\\"Product Quality\\\"\",\"NEW: \\\"Yield\\\"\",\"Crop failure\",\"Production inputs (fertilizer, pesticides)\",\"NEW: \\\"Waste/Losses\\\")\",\"Total qty. food products\",\"Total qty. forest products\",\"Total qty. non-food ag. products\",\"NEW: \\\"Production Species Diversity\\\"\",\"Nutrition\",\"Food safety\",\"NEW: \\\"Product Safety\\\" (Not livestock specific)\",\"Techology adoption (reverse osmosis, tapping practices)\",\"Total qty. exported\",\"Total qty. imported\",\"Value-added market\",\"Marketability\",\"Recalls in each industry\",\"\\\"Waste\\\" converted to useable byproduct\",\"Crop rotations\",\"Food wasted\",\"Nutritional staples\",\"Certificates of assurance\",\"Food losses\",\"Livestock product safety\",\"Richness\"],\"Score\":[9,9,9,8,8,7,7,7,7,6,6,5,5,5,5,5,5,4,4,3,3,3,3,2,2,1,1],\"Proportion Must Include\":[\"1.00\",\"1.00\",\"1.00\",\"0.67\",\"0.67\",\"0.67\",\"0.67\",\"0.67\",\"0.67\",\"0.67\",\"0.00\",\"0.33\",\"0.50\",\"0.33\",\"0.33\",\"0.33\",\"0.33\",\"0.00\",\"0.00\",\"0.00\",\"0.00\",\"0.00\",\"0.00\",\"0.00\",\"0.00\",\"0.00\",\"0.00\"],\"Proportion Must OR Probably Include\":[\"1.00\",\"1.00\",\"1.00\",\"1.00\",\"1.00\",\"0.67\",\"0.67\",\"0.67\",\"0.67\",\"0.67\",\"1.00\",\"0.33\",\"1.00\",\"0.33\",\"0.33\",\"0.33\",\"0.67\",\"0.33\",\"0.33\",\"0.33\",\"0.00\",\"0.00\",\"0.00\",\"0.33\",\"0.00\",\"0.00\",\"0.00\"]},\"columns\":[{\"id\":\"Indicator\",\"name\":\"Indicator\",\"type\":\"factor\",\"format\":{\"cell\":{\"digits\":2},\"aggregated\":{\"digits\":2}},\"minWidth\":200,\"align\":\"left\"},{\"id\":\"Score\",\"name\":\"Score\",\"type\":\"numeric\",\"format\":{\"cell\":{\"digits\":0},\"aggregated\":{\"digits\":0}},\"minWidth\":75,\"align\":\"right\"},{\"id\":\"Proportion Must Include\",\"name\":\"Proportion Must Include\",\"type\":\"character\",\"format\":{\"cell\":{\"digits\":2},\"aggregated\":{\"digits\":2}},\"minWidth\":200,\"align\":\"right\"},{\"id\":\"Proportion Must OR Probably Include\",\"name\":\"Proportion Must OR Probably Include\",\"type\":\"character\",\"format\":{\"cell\":{\"digits\":2},\"aggregated\":{\"digits\":2}},\"minWidth\":200,\"align\":\"right\"}],\"resizable\":true,\"searchable\":true,\"defaultPageSize\":10,\"showPageSizeOptions\":true,\"pageSizeOptions\":[5,10,25,50,100],\"bordered\":true,\"striped\":true,\"compact\":true,\"inline\":true,\"dataKey\":\"b06332540e8ec53076832f8438d84bed\"},\"children\":[]},\"class\":\"reactR_markup\"},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n\n### Indices\n\n\n\n\n::: {.cell layout-align=\"center\" warnings='false'}\n\n```{.r .cell-code}\n# Add scores by multipliers\nmultipliers <- c(3:1)\nidx_tables <- map2(idx_out[1:3], multipliers, ~ {\n  .x %>% \n    mutate(\n      freq = as.numeric(freq),\n      multiplier = .y,\n      score = freq * multiplier,\n    ) %>% \n    select(index = indicator, freq, score)\n})\n\n# Set up DF for color graph \ngraph_table <- imap(idx_tables, ~ {\n  col_name <- str_remove(.y, 'idx_')\n  .x %>% \n    rename(!!sym(col_name) := freq) %>% \n    select(-score)\n}) %>% \n  reduce(full_join) %>% \n  mutate(\n    across(where(is.numeric), ~ ifelse(is.na(.x), 0, .x)),\n    sort_key = must * 1e6 + probably * 1e4 + probably_not,\n    sort_key = ifelse(str_detect(index, 'Carbon'), 5e6, sort_key),\n    index = fct_reorder(index, sort_key, .desc = TRUE)\n  ) %>% \n  pivot_longer(\n    cols = must:probably_not,\n    names_to = \"category\",\n    values_to = \"count\"\n  ) %>% \n  mutate(\n    category = fct_relevel(\n      category, \n      # \"must_not\",\n      \"probably_not\", \n      \"probably\", \n      \"must\"\n    )\n  ) %>%\n  group_by(index) %>%\n  mutate(proportion = count / sum(count)) %>%\n  ungroup()\n\n\ncolors <- RColorBrewer::brewer.pal(4, 'RdBu')\n\nggplot(graph_table, aes(\n  y = reorder(index, sort_key),\n  x = proportion, \n  fill = category\n)) +\n  geom_col(position = \"stack\") +  \n  labs(\n    y = \"Index\",\n    x = \"Proportion\",\n    fill = \"Category\"\n  ) +\n  theme_minimal() +\n  theme(\n    text = element_text(size = 20),\n    legend.position = 'top'\n    ) +\n  scale_fill_manual(\n    values = rev(colors),\n    limits = c(\n      \"must\",\n      \"probably\",\n      \"probably_not\"\n    ),\n    labels = c(\n      \"Must Include\",\n      \"Probably Include\",\n      \"Probably Not Include\"\n    )\n  )\n```\n\n::: {.cell-output-display}\n![](refine_production_files/figure-html/idx_graphs-1.png){fig-align='center' width=90%}\n:::\n:::\n\n::: {.cell warnings='false' class='centered-table'}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"reactable html-widget html-fill-item\" id=\"htmlwidget-627525d01fd442bdac89\" style=\"width:auto;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-627525d01fd442bdac89\">{\"x\":{\"tag\":{\"name\":\"Reactable\",\"attribs\":{\"data\":{\"Index\":[\"Product quality\",\"Production efficiency\",\"Imports vs. exports\",\"Production diversity\",\"Waste/losses\",\"Production margins\"],\"Score\":[8,8,7,7,7,6],\"Proportion Must Include\":[\"0.67\",\"0.67\",\"0.33\",\"0.33\",\"0.33\",\"0.33\"],\"Proportion Must OR Probably Include\":[\"1.00\",\"1.00\",\"1.00\",\"1.00\",\"1.00\",\"0.67\"]},\"columns\":[{\"id\":\"Index\",\"name\":\"Index\",\"type\":\"factor\",\"format\":{\"cell\":{\"digits\":2},\"aggregated\":{\"digits\":2}},\"minWidth\":200,\"align\":\"left\"},{\"id\":\"Score\",\"name\":\"Score\",\"type\":\"numeric\",\"format\":{\"cell\":{\"digits\":0},\"aggregated\":{\"digits\":0}},\"minWidth\":75,\"align\":\"right\"},{\"id\":\"Proportion Must Include\",\"name\":\"Proportion Must Include\",\"type\":\"character\",\"format\":{\"cell\":{\"digits\":2},\"aggregated\":{\"digits\":2}},\"minWidth\":200,\"align\":\"right\"},{\"id\":\"Proportion Must OR Probably Include\",\"name\":\"Proportion Must OR Probably Include\",\"type\":\"character\",\"format\":{\"cell\":{\"digits\":2},\"aggregated\":{\"digits\":2}},\"minWidth\":200,\"align\":\"right\"}],\"resizable\":true,\"searchable\":true,\"pagination\":false,\"defaultPageSize\":10,\"showPageSizeOptions\":false,\"bordered\":true,\"striped\":true,\"compact\":true,\"inline\":true,\"dataKey\":\"2f37d6bda99b1ea375d539ee4d9dfda0\"},\"children\":[]},\"class\":\"reactR_markup\"},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/core-js-2.5.3/shim.min.js\"></script>\n<script src=\"../site_libs/react-18.2.0/react.min.js\"></script>\n<script src=\"../site_libs/react-18.2.0/react-dom.min.js\"></script>\n<script src=\"../site_libs/reactwidget-2.0.0/react-tools.js\"></script>\n<link href=\"../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"../site_libs/reactable-0.4.4/reactable.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/reactable-binding-0.4.4/reactable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}